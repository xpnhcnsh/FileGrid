@page "/profile"
@attribute [Authorize]
@using FileGrid.Entities
@using FileGrid.Services.Interface
@using Microsoft.AspNetCore.Components.Web
@using System.Security.Claims
@inject NavigationManager NavigationManager
@inject AuthenticationStateProvider AuthStateProvider
@inject IUserService UserService
@inject ICompanyService CompanyService
@inject ISnackbar Snackbar


<MudContainer MaxWidth="MaxWidth.Medium" Class="pa-4 mt-12 pa-sm-4">
    @if (_user == null)
    {
        <div class="d-flex justify-center my-8">
            <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
        </div>
    }
    else
    {
        <MudCard Class="elevation-1 elevation-sm-3 ">
            <!-- Header -->
            <MudCardHeader Class="d-flex flex-column flex-sm-row align-center">
                <MudAvatar Size="@(_isMobile? Size.Medium: Size.Large)" Color="Color.Primary"
                    Class="mb-2 mt-2 mb-sm-0 mr-sm-4">
                    @(_avatar)
                </MudAvatar>
                <div class="d-flex flex-row align-center align-sm-start">
                    @if (!_editMode)
                    {
                        <MudText Typo="@(_isMobile? Typo.h5: Typo.h3)" Class="text-center text-sm-left">
                            @(string.IsNullOrEmpty(_user.Name) ? "无名" : _user.Name)
                        </MudText>
                    }
                    else
                    {
                        <MudTextField @bind-Value="_editUser.Name" Label="姓名" FullWidth="true" Margin="Margin.Dense" />
                    }
                    <MudChip Class="ml-2" T="string" Color="Color.Secondary" Variant="Variant.Text"
                        Size="@(_isMobile ? Size.Small : Size.Medium)">
                        @($"用户组：{_user.UserGroup}")
                    </MudChip>
                </div>
                <div class="ml-auto">
                    @if (!_editMode)
                    {
                        <MudIconButton Icon="@Icons.Material.Filled.Edit" OnClick="EnableEdit" />
                    }
                    else
                    {
                        <MudIconButton Icon="@Icons.Material.Filled.Check" Color="Color.Success" OnClick="SaveAsync" />
                        <MudIconButton Icon="@Icons.Material.Filled.Close" Color="Color.Error" OnClick="CancelEdit" />
                    }
                </div>
            </MudCardHeader>

            <!-- Content -->
            <MudCardContent>
                <MudGrid Spacing="3">
                    <!-- 基本信息 -->
                    <MudItem xs="12" sm="6" Class="order-2 order-sm-1">
                        <MudPaper Elevation="0" Class="pa-3" Outlined>
                            <MudText Typo="Typo.subtitle1" Color="Color.Primary" Class="mb-3">
                                基本信息
                            </MudText>
                            <MudList T="string">
                                <!-- 邮箱项 -->
                                <MudListItem Class="py-1"> 
                                    <div class="d-flex flex-column">
                                        <div class="d-flex align-items-center flex-nowrap">
                                            <MudIcon Icon="@Icons.Material.Filled.Email"
                                                Size="@(_isMobile ? Size.Small : Size.Medium)" Class="mr-2" />
                                            <MudText Typo="Typo.subtitle1" Class="mr-2">邮箱</MudText>
                                        </div>
                                        @if (!_editMode)
                                        {
                                            <MudText Typo="Typo.subtitle1">
                                                @(_user.Email ?? "未设置")
                                            </MudText>
                                        }
                                        else
                                        {
                                            <MudTextField @bind-Value="_editUser.Email" FullWidth="true"
                                                Margin="Margin.Dense" />
                                        }
                                    </div>
                                </MudListItem>

                                <!-- 联系电话项 -->
                                <MudListItem Class="py-1"> 
                                    <div class="d-flex flex-column">
                                        <div class="d-flex align-items-center flex-nowrap">
                                            <MudIcon Icon="@Icons.Material.Filled.Phone"
                                                Size="@(_isMobile ? Size.Small : Size.Medium)" Class="mr-2" />
                                            <MudText Typo="Typo.subtitle1" Class="mr-2">电话</MudText>
                                        </div>
                                        @if (!_editMode)
                                        {
                                            <MudText Typo="Typo.subtitle1">
                                                @(_user.PhoneNumber ?? "未设置")
                                            </MudText>
                                        }
                                        else
                                        {
                                            <MudTextField @bind-Value="_editUser.PhoneNumber" FullWidth="true"
                                                Margin="Margin.Dense" />
                                        }
                                    </div>
                                </MudListItem>
                            </MudList>
                        </MudPaper>
                    </MudItem>

                    <!-- 组织信息 -->
                    <MudItem xs="12" sm="6" Class="order-1 order-sm-2 mb-4 mb-sm-0">
                        <MudPaper Elevation="0" Class="pa-3" Outlined>
                            <MudText Typo="Typo.subtitle1" Color="Color.Primary" Class="mb-3">
                                组织信息
                            </MudText>
                            <MudList T="string">
                                <MudListItem Class="py-1"> 
                                    <div class="d-flex flex-column">
                                        <div class="d-flex align-items-center flex-nowrap">
                                            <MudIcon Icon="@Icons.Material.Filled.Business"
                                                Size="@(_isMobile ? Size.Small : Size.Medium)" Class="mr-2" />
                                            <MudText Typo="Typo.subtitle1" Class="mr-2">公司</MudText>
                                        </div>
                                        @if (!_editMode)
                                        {
                                            <MudText Typo="Typo.subtitle1">
                                                @(_user.Company?.Name ?? "未设置")
                                            </MudText>
                                        }
                                        else
                                        {
                                            <MudSelect T="int?" @bind-Value="_editUser.CompanyId" FullWidth="true"
                                                Margin="Margin.Dense" OnValueChanged="">
                                                @foreach (var c in _companyList)
                                                {
                                                    <MudSelectItem Value="c">@c.Name</MudSelectItem>
                                                }
                                            </MudSelect>
                                        }
                                    </div>
                                </MudListItem>

                                <MudListItem Class="py-1"> 
                                    <div class="d-flex flex-column">
                                        <div class="d-flex align-items-center flex-nowrap">
                                            <MudIcon Icon="@Icons.Material.Filled.AccountTree"
                                                Size="@(_isMobile ? Size.Small : Size.Medium)" Class="mr-2" />
                                            <MudText Typo="Typo.subtitle1" Class="mr-2">部门</MudText>
                                        </div>
                                        @if (!_editMode)
                                        {
                                            <MudText Typo="Typo.subtitle1">
                                                @(_user.Department?.Name ?? "未设置")
                                            </MudText>
                                        }
                                        else
                                        {
                                            <MudSelect T="int?" @bind-Value="_editUser.DepartmentId" FullWidth="true"
                                                Margin="Margin.Dense">
                                                @foreach (var dept in _filteredDepartments)
                                                {
                                                    <MudSelectItem Value="@dept.Id">@dept.Name</MudSelectItem>
                                                }
                                            </MudSelect>
                                        }
                                    </div>
                                </MudListItem>

                                <MudListItem Class="py-1"> 
                                    <div class="d-flex flex-column">
                                        <div class="d-flex align-items-center flex-nowrap">
                                            <MudIcon Icon="@Icons.Material.Filled.Work"
                                                Size="@(_isMobile ? Size.Small : Size.Medium)" Class="mr-2" />
                                            <MudText Typo="Typo.subtitle1" Class="mr-2">职务</MudText>
                                        </div>
                                        @if (!_editMode)
                                        {
                                            <MudText Typo="Typo.subtitle1">
                                                @(_user.JobTitle ?? "未设置")
                                            </MudText>
                                        }
                                        else
                                        {
                                            <MudTextField @bind-Value="_editUser.JobTitle" FullWidth="true"
                                                Margin="Margin.Dense" />
                                        }
                                    </div>
                                </MudListItem>
                            </MudList>
                        </MudPaper>
                    </MudItem>
                </MudGrid>
            </MudCardContent>
        </MudCard>
    }
</MudContainer>



@code {
    private bool _editMode = false;
    private User _user = null!;
    private User _editUser = null!;
    private bool _isMobile;
    private string? _avatar = "U";
    public Guid Id { get; } = Guid.NewGuid();
    private List<Company> _companyList = new();
    private List<Department> _departmentList = new();
    private IEnumerable<Department> _filteredDepartments =>
    _departmentList.Where(d => d.CompanyId == _editUser.CompanyId);

    protected override async Task OnInitializedAsync()
    {
        var userId = (await AuthStateProvider.GetAuthenticationStateAsync()).User.FindFirst(ClaimTypes.NameIdentifier)?.Value;
        if (userId != null)
        {
            var res = await UserService.GetUserByIdAsync(Guid.Parse(userId));
            if (res != null)
            {
                _user = res;
                string? temp = !string.IsNullOrEmpty(_user.Name) ? _user.Name.FirstOrDefault().ToString().ToUpperInvariant() :
                (!string.IsNullOrEmpty(_user.Email) ? _user.Email.FirstOrDefault().ToString().ToUpperInvariant() : "U");
                if (temp != null)
                {
                    _avatar = temp;
                }
                _companyList = await CompanyService.GetAllCompaniesAsync();
                _departmentList = await CompanyService.GetAllDepartmentsAsync();
            }
        }
    }

    private void EnableEdit()
    {
        _editUser = new User
        {
            Id = _user.Id,
            Email = _user.Email,
            Name = _user.Name,
            PhoneNumber = _user.PhoneNumber,
            Department = _user.Department,
            JobTitle = _user.JobTitle,
            Company = _user.Company
        };
        _editMode = true;
    }

    private async Task SaveAsync()
    {
        User? updated = await UserService.UpdateUserAsync(_editUser);
        if (updated == null)
        {
            Snackbar.Add("更新信息失败", Severity.Error);
            return;
        }
        _user = updated!;
        _editMode = false;
    }

    private void CancelEdit()
    {
        _editMode = false;
    }

    private void OnCompanyChanged()
    {
        _editUser.DepartmentId = 0;
    }
}